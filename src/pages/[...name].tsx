import DateTimePicker from "@/components/DateTimePicker";
import { prisma } from "@/server/db";
import { api } from "@/utils/api";
import { DateType, Inputs } from "@/utils/types";
import "@fontsource/roboto/300.css";
import "@fontsource/roboto/400.css";
import "@fontsource/roboto/500.css";
import "@fontsource/roboto/700.css";
import { Button } from "@mui/material";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";
import {
  GetStaticPaths,
  GetStaticPropsContext,
  InferGetStaticPropsType,
} from "next";
import Head from "next/head";
import { useRouter } from "next/router";
import { useState } from "react";
import { useForm } from "react-hook-form";
import { Toaster, toast } from "react-hot-toast";

export default function Home({
  admin,
  notFound,
}: InferGetStaticPropsType<typeof getStaticProps>) {
  const utils = api.useContext();

  const {} = useForm<Inputs>();

  const [date, setDate] = useState<DateType>({
    justDate: null,
    dateTime: null,
  });
  const [animate, setAnimate] = useState<boolean>(true);
  const router = useRouter();

  const { mutate: createReservation, isLoading: isCreating } =
    api.reservation.createReservation.useMutation({
      onSuccess: () => {
        toast.success("HorÃ¡rio reservado com sucesso!");
        utils.reservation.getAll.invalidate();
        utils.reservation.getByDate.invalidate();
      },
      onError: (err) => {
        toast.error(err.message);
      },
    });

  return (
    <>
      <Head>
        <title>{admin ? admin.name : "Create T3 App"}</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main
        className={`flex min-h-screen w-screen flex-col items-center justify-center overflow-y-scroll`}
      >
        {!admin ? (
          <h1 className="text-2xl font-bold">404 - page not found</h1>
        ) : (
          <div
            className={`flex min-h-screen w-screen flex-col items-center justify-center overflow-y-scroll`}
          >
            <h2
              onAnimationEnd={() => setAnimate(false)}
              className={`text-4xl font-bold ${animate && "animate-fadeIn"}`}
            >
              {date.dateTime
                ? format(date.dateTime, "dd 'de' MMMM, kk:mm", { locale: ptBR })
                : date.justDate
                ? format(date.justDate, "dd 'de' MMMM, --:--", { locale: ptBR })
                : "-- --, --:--"}
            </h2>

            <DateTimePicker
              date={date}
              setAnimate={setAnimate}
              setDate={setDate}
              adminId={admin?.id}
            />

            <Button
              className="mt-8"
              variant="contained"
              sx={{ color: "rgb(21, 101, 192)", "&:hover": { color: "white" } }}
              disabled={(date.dateTime ? false : true) || isCreating}
              onClick={() => {
                localStorage.setItem("dateTime", date.dateTime!.toISOString());
                if (admin) localStorage.setItem("adminId", admin.id);
                router.push("/booking");
                // createReservation({ date: date.dateTime! })
              }}
            >
              {isCreating ? "Criando..." : "Reservar"}
            </Button>
          </div>
        )}

        <Toaster position="bottom-center" />
      </main>
    </>
  );
}

export const getStaticProps = async (context: GetStaticPropsContext) => {
  try {
    const { params } = context;
    if (params && params.name) {
      const admin = await prisma.admin.findFirst({
        where: { name: params.name[0] },
      });
      if (admin) return { props: { admin } };
      throw new Error("Not found");
    }
  } catch (err) {
    return { props: { notFound: true } };
  }
};

export const getStaticPaths: GetStaticPaths = async () => {
  return { paths: [], fallback: "blocking" };
};
